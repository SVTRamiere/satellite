<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte satellite avec animation m√©t√©o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }
    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 999;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      font-family: sans-serif;
    }
    #exportBtn {
      margin-top: 10px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="controls">
    <button id="play">‚ñ∂Ô∏è Animer</button>
    <select id="timeSelect"></select>
    <button id="exportBtn">üñºÔ∏è Exporter carte</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const map = L.map('map').setView([47.5, 2], 6);

    // Fond de carte satellite
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri'
    }).addTo(map);

    const apiKey = "0b9fa4a8f48537427496561d2fb532bb";
    const times = [];

    const now = new Date();
    now.setUTCMinutes(0, 0, 0);
    for (let i = 5; i >= 0; i--) {
      const t = new Date(now.getTime() - i * 60 * 60 * 1000);
      const iso = t.toISOString().split('.')[0] + "Z";
      times.push(iso);
    }

    const select = document.getElementById("timeSelect");
    times.forEach((time, i) => {
      const opt = document.createElement("option");
      opt.value = time;
      opt.text = new Date(time).toLocaleTimeString('fr-FR', { timeZone: 'UTC' }) + " UTC";
      select.appendChild(opt);
    });

    let layerPrecip, layerClouds;
    function updateLayers(time) {
      if (layerPrecip) map.removeLayer(layerPrecip);
      if (layerClouds) map.removeLayer(layerClouds);

      layerPrecip = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${apiKey}&tm=${time}`, {
        opacity: 0.6
      }).addTo(map);

      layerClouds = L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${apiKey}&tm=${time}`, {
        opacity: 0.4
      }).addTo(map);
    }

    select.addEventListener("change", () => {
      updateLayers(select.value);
    });

    let interval;
    document.getElementById("play").addEventListener("click", () => {
      let i = 0;
      if (interval) clearInterval(interval);
      interval = setInterval(() => {
        updateLayers(times[i]);
        select.selectedIndex = i;
        i = (i + 1) % times.length;
      }, 1500);
    });

    updateLayers(times[0]);
    select.value = times[0];

    // Export image via html2canvas
    document.getElementById("exportBtn").addEventListener("click", () => {
      html2canvas(document.querySelector("#map"), {useCORS: true}).then(canvas => {
        const link = document.createElement("a");
        link.download = "carte_meteo.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>
</body>
</html>
